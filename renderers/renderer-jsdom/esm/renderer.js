import { JSDOM } from 'jsdom';
import Bluebird from 'bluebird';
export class JSDOMRenderer {
    constructor(rendererOptions) {
        this._rendererOptions = {};
        Object.assign(this._rendererOptions, rendererOptions);
        if (this._rendererOptions.maxConcurrentRoutes == null)
            this._rendererOptions.maxConcurrentRoutes = 0;
        if (this._rendererOptions.inject && !this._rendererOptions.injectProperty) {
            this._rendererOptions.injectProperty = '__PRERENDER_INJECTED';
        }
    }
    initialize() {
        // NOOP
        return Bluebird.resolve();
    }
    renderRoutes(routes, Prerenderer) {
        const rootOptions = Prerenderer.getOptions();
        const self = this;
        return Bluebird
            .resolve(routes)
            .bind(self)
            .map((route) => {
            return new Bluebird(async (resolve, reject) => {
                const jsdom = await JSDOM.fromURL(`http://127.0.0.1:${rootOptions.server.port}${route}`, {
                    resources: 'usable',
                    runScripts: 'dangerously',
                });
                const { window } = jsdom;
                if (self._rendererOptions.inject) {
                    window[self._rendererOptions.injectProperty] = self._rendererOptions.inject;
                }
                window.addEventListener('error', function (event) {
                    console.error(event.error);
                });
                return getPageContents(jsdom, self._rendererOptions, route);
            });
        })
            .tapCatch(e => {
            console.error(e);
        });
    }
    destroy() {
        // NOOP
    }
}
export function getPageContents(jsdom, options, originalRoute) {
    options = options || {};
    const { window } = jsdom;
    const { document } = window;
    return new Bluebird((resolve, reject) => {
        let int;
        async function captureDocument() {
            if (options.renderAfterDelay > 0) {
                await Bluebird.delay(options.renderAfterDelay | 0);
            }
            const result = {
                originalRoute: originalRoute,
                route: originalRoute,
                html: jsdom.serialize(),
            };
            if (int != null) {
                clearInterval(int);
            }
            window.close();
            return result;
        }
        let bool;
        // CAPTURE WHEN AN EVENT FIRES ON THE DOCUMENT
        if (options.renderAfterDocumentEvent) {
            bool = true;
            document.addEventListener(options.renderAfterDocumentEvent, () => resolve(captureDocument()));
            // CAPTURE ONCE A SPECIFC ELEMENT EXISTS
        }
        if (options.renderAfterElementExists) {
            bool = true;
            // @ts-ignore
            int = setInterval(() => {
                if (document.querySelector(options.renderAfterElementExists))
                    resolve(captureDocument());
            }, 100);
            // CAPTURE AFTER A NUMBER OF MILLISECONDS
        }
        if (bool) {
            setTimeout(() => resolve(captureDocument()), (options.renderAfterTimeMax | 0) || 30000);
        }
        else if (options.renderAfterTime) {
            setTimeout(() => resolve(captureDocument()), options.renderAfterTime);
            // DEFAULT: RUN IMMEDIATELY
        }
        else {
            resolve(captureDocument());
        }
    });
}
export default JSDOMRenderer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmVuZGVyZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFhLEtBQUssRUFBRSxNQUFNLE9BQU8sQ0FBQTtBQUN4QyxPQUFPLFFBQVEsTUFBTSxVQUFVLENBQUE7QUFnRC9CLE1BQU0sT0FBTyxhQUFhO0lBSXpCLFlBQVksZUFBc0M7UUFGeEMscUJBQWdCLEdBQTBCLEVBQUUsQ0FBQztRQUl0RCxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxlQUFlLENBQUMsQ0FBQztRQUV0RCxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxtQkFBbUIsSUFBSSxJQUFJO1lBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLG1CQUFtQixHQUFHLENBQUMsQ0FBQztRQUVyRyxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxFQUN6RTtZQUNDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxjQUFjLEdBQUcsc0JBQXNCLENBQUE7U0FDN0Q7SUFDRixDQUFDO0lBRUQsVUFBVTtRQUVULE9BQU87UUFDUCxPQUFPLFFBQVEsQ0FBQyxPQUFPLEVBQUUsQ0FBQTtJQUMxQixDQUFDO0lBRUQsWUFBWSxDQUFDLE1BQWUsRUFBRSxXQUU3QjtRQUVBLE1BQU0sV0FBVyxHQUFHLFdBQVcsQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUU3QyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUM7UUFFbEIsT0FBTyxRQUFRO2FBQ2IsT0FBTyxDQUFDLE1BQU0sQ0FBQzthQUNmLElBQUksQ0FBQyxJQUFJLENBQUM7YUFDVixHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUVmLE9BQU8sSUFBSSxRQUFRLENBQVUsS0FBSyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtnQkFFdEQsTUFBTSxL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R0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLGVBQWUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsa0JBQWtCLEdBQUcsQ0FBQyxDQUFDLElBQUksS0FBSyxDQUFDLENBQUE7U0FDdkY7YUFDSSxJQUFJLE9BQU8sQ0FBQyxlQUFlLEVBQ2hDO1lBQ0MsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQTtZQUVyRSwyQkFBMkI7U0FDM0I7YUFFRDtZQUNDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFBO1NBQzFCO0lBQ0YsQ0FBQyxDQUFDLENBQUE7QUFDSCxDQUFDO0FBRUQsZUFBZSxhQUFhLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBET01XaW5kb3csIEpTRE9NIH0gZnJvbSAnanNkb20nXG5pbXBvcnQgQmx1ZWJpcmQgZnJvbSAnYmx1ZWJpcmQnXG5cbmV4cG9ydCBpbnRlcmZhY2UgSUpTRE9NUmVuZGVyZXJPcHRpb25zXG57XG5cdC8qKlxuXHQgKiAwIChObyBsaW1pdClcblx0ICpcblx0ICogVGhlIG51bWJlciBvZiByb3V0ZXMgYWxsb3dlZCB0byBiZSByZW5kZXJlZCBhdCB0aGUgc2FtZSB0aW1lLiBVc2VmdWwgZm9yIGJyZWFraW5nIGRvd24gbWFzc2l2ZSBiYXRjaGVzIG9mIHJvdXRlcyBpbnRvIHNtYWxsZXIgY2h1bmtzLlxuXHQgKi9cblx0bWF4Q29uY3VycmVudFJvdXRlcz86IG51bWJlcixcblx0LyoqXG5cdCAqIEFuIG9iamVjdCB0byBpbmplY3QgaW50byB0aGUgZ2xvYmFsIHNjb3BlIG9mIHRoZSByZW5kZXJlZCBwYWdlIGJlZm9yZSBpdCBmaW5pc2hlcyBsb2FkaW5nLiBNdXN0IGJlIEpTT04uc3RyaW5naWZpeS1hYmxlLiBUaGUgcHJvcGVydHkgaW5qZWN0ZWQgdG8gaXMgd2luZG93WydfX1BSRVJFTkRFUl9JTkpFQ1RFRCddIGJ5IGRlZmF1bHQuXG5cdCAqL1xuXHRpbmplY3Q/OiBvYmplY3QsXG5cdC8qKlxuXHQgKiBUaGUgcHJvcGVydHkgdG8gbW91bnQgaW5qZWN0IHRvIGR1cmluZyByZW5kZXJpbmcuXG5cdCAqL1xuXHRpbmplY3RQcm9wZXJ0eT86IHN0cmluZyxcblx0LyoqXG5cdCAqIFdhaXQgdG8gcmVuZGVyIHVudGlsIHRoZSBzcGVjaWZpZWQgZXZlbnQgaXMgZmlyZWQgb24gdGhlIGRvY3VtZW50LiAoWW91IGNhbiBmaXJlIGFuIGV2ZW50IGxpa2Ugc286IGRvY3VtZW50LmRpc3BhdGNoRXZlbnQobmV3IEV2ZW50KCdjdXN0b20tcmVuZGVyLXRyaWdnZXInKSlcblx0ICovXG5cdHJlbmRlckFmdGVyRG9jdW1lbnRFdmVudD86IHN0cmluZyxcblx0LyoqXG5cdCAqIChTZWxlY3Rvcilcblx0ICpcblx0ICogV2FpdCB0byByZW5kZXIgdW50aWwgdGhlIHNwZWNpZmllZCBlbGVtZW50IGlzIGRldGVjdGVkIHVzaW5nIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Jcblx0ICovXG5cdHJlbmRlckFmdGVyRWxlbWVudEV4aXN0cz86IHN0cmluZyxcblx0LyoqXG5cdCAqIChNaWxsaXNlY29uZHMpXG5cdCAqXG5cdCAqIFdhaXQgdG8gcmVuZGVyIHVudGlsIGEgY2VydGFpbiBhbW91bnQgb2YgdGltZSBoYXMgcGFzc2VkLlxuXHQgKi9cblx0cmVuZGVyQWZ0ZXJUaW1lPzogbnVtYmVyLFxuXG5cdC8qKlxuXHQgKiB0aGUgbWF4IHRpbWVvdXRcblx0ICovXG5cdHJlbmRlckFmdGVyVGltZU1heD86IG51bWJlcixcblxuXHQvKipcblx0ICogZGVsYXkgYWZ0ZXIgcmVuZGVyQWZ0ZXJEb2N1bWVudEV2ZW50IHJlbmRlckFmdGVyRWxlbWVudEV4aXN0c1xuXHQgKi9cblx0cmVuZGVyQWZ0ZXJEZWxheT86IG51bWJlcixcbn1cblxuZXhwb3J0IHR5cGUgSVJvdXRlcyA9IHN0cmluZ1tdO1xuXG5leHBvcnQgY2xhc3MgSlNET01SZW5kZXJlclxue1xuXHRwcm90ZWN0ZWQgX3JlbmRlcmVyT3B0aW9uczogSUpTRE9NUmVuZGVyZXJPcHRpb25zID0ge307XG5cblx0Y29uc3RydWN0b3IocmVuZGVyZXJPcHRpb25zOiBJSlNET01SZW5kZXJlck9wdGlvbnMpXG5cdHtcblx0XHRPYmplY3QuYXNzaWduKHRoaXMuX3JlbmRlcmVyT3B0aW9ucywgcmVuZGVyZXJPcHRpb25zKTtcblxuXHRcdGlmICh0aGlzLl9yZW5kZXJlck9wdGlvbnMubWF4Q29uY3VycmVudFJvdXRlcyA9PSBudWxsKSB0aGlzLl9yZW5kZXJlck9wdGlvbnMubWF4Q29uY3VycmVudFJvdXRlcyA9IDA7XG5cblx0XHRpZiAodGhpcy5fcmVuZGVyZXJPcHRpb25zLmluamVjdCAmJiAhdGhpcy5fcmVuZGVyZXJPcHRpb25zLmluamVjdFByb3BlcnR5KVxuXHRcdHtcblx0XHRcdHRoaXMuX3JlbmRlcmVyT3B0aW9ucy5pbmplY3RQcm9wZXJ0eSA9ICdfX1BSRVJFTkRFUl9JTkpFQ1RFRCdcblx0XHR9XG5cdH1cblxuXHRpbml0aWFsaXplKClcblx0e1xuXHRcdC8vIE5PT1Bcblx0XHRyZXR1cm4gQmx1ZWJpcmQucmVzb2x2ZSgpXG5cdH1cblxuXHRyZW5kZXJSb3V0ZXMocm91dGVzOiBJUm91dGVzLCBQcmVyZW5kZXJlcjoge1xuXHRcdGdldE9wdGlvbnMoKTogSVByZXJlbmRlcmVyT3B0aW9uc1xuXHR9KTogQmx1ZWJpcmQ8SVJlc3VsdFtdPlxuXHR7XG5cdFx0Y29uc3Qgcm9vdE9wdGlvbnMgPSBQcmVyZW5kZXJlci5nZXRPcHRpb25zKCk7XG5cblx0XHRjb25zdCBzZWxmID0gdGhpcztcblxuXHRcdHJldHVybiBCbHVlYmlyZFxuXHRcdFx0LnJlc29sdmUocm91dGVzKVxuXHRcdFx0LmJpbmQoc2VsZilcblx0XHRcdC5tYXAoKHJvdXRlKSA9PlxuXHRcdHtcblx0XHRcdHJldHVybiBuZXcgQmx1ZWJpcmQ8SVJlc3VsdD4oYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT5cblx0XHRcdHtcblx0XHRcdFx0Y29uc3QganNkb20gPSBhd2FpdCBKU0RPTS5mcm9tVVJMKGBodHRwOi8vMTI3LjAuMC4xOiR7cm9vdE9wdGlvbnMuc2VydmVyLnBvcnR9JHtyb3V0ZX1gLCB7XG5cdFx0XHRcdFx0cmVzb3VyY2VzOiAndXNhYmxlJyxcblx0XHRcdFx0XHRydW5TY3JpcHRzOiAnZGFuZ2Vyb3VzbHknLFxuXHRcdFx0XHR9KTtcblxuXHRcdFx0XHRjb25zdCB7IHdpbmRvdyB9ID0ganNkb207XG5cblx0XHRcdFx0aWYgKHNlbGYuX3JlbmRlcmVyT3B0aW9ucy5pbmplY3QpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHR3aW5kb3dbc2VsZi5fcmVuZGVyZXJPcHRpb25zLmluamVjdFByb3BlcnR5XSA9IHNlbGYuX3JlbmRlcmVyT3B0aW9ucy5pbmplY3Rcblx0XHRcdFx0fVxuXG5cdFx0XHRcdHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIGZ1bmN0aW9uIChldmVudClcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGNvbnNvbGUuZXJyb3IoZXZlbnQuZXJyb3IpXG5cdFx0XHRcdH0pO1xuXG5cdFx0XHRcdHJldHVybiBnZXRQYWdlQ29udGVudHMoanNkb20sIHNlbGYuX3JlbmRlcmVyT3B0aW9ucywgcm91dGUpXG5cdFx0XHR9KVxuXHRcdH0pXG5cdFx0XHQudGFwQ2F0Y2goZSA9PlxuXHRcdFx0e1xuXHRcdFx0XHRjb25zb2xlLmVycm9yKGUpXG5cdFx0XHR9KVxuXHRcdDtcblx0fVxuXG5cdGRlc3Ryb3koKVxuXHR7XG5cdFx0Ly8gTk9PUFxuXHR9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVBvc3RQcm9jZXNzQ29udGV4dFxue1xuXHQvKipcblx0ICogVGhlIHByZXJlbmRlcmVkIHJvdXRlLCBhZnRlciBmb2xsb3dpbmcgcmVkaXJlY3RzLlxuXHQgKi9cblx0cm91dGU6IHN0cmluZ1xuXHQvKipcblx0ICogVGhlIG9yaWdpbmFsIHJvdXRlIHBhc3NlZCwgYmVmb3JlIHJlZGlyZWN0cy5cblx0ICovXG5cdG9yaWdpbmFsUm91dGU6IHN0cmluZ1xuXHQvKipcblx0ICogVGhlIHBhdGggdG8gd3JpdGUgdGhlIHJlbmRlcmVkIEhUTUwgdG8uXG5cdCAqL1xuXHRodG1sOiBzdHJpbmdcblx0LyoqXG5cdCAqIFRoZSBwYXRoIHRvIHdyaXRlIHRoZSByZW5kZXJlZCBIVE1MIHRvLlxuXHQgKiBUaGlzIGlzIG51bGwgKGF1dG9tYXRpY2FsbHkgY2FsY3VsYXRlZCBhZnRlciBwb3N0UHJvY2Vzcylcblx0ICogdW5sZXNzIGV4cGxpY2l0bHkgc2V0LlxuXHQgKi9cblx0b3V0cHV0UGF0aD86IHN0cmluZ1xufVxuXG5leHBvcnQgdHlwZSBJUmVzb2x2YWJsZTxSPiA9IFIgfCBQcm9taXNlTGlrZTxSPjtcblxuZXhwb3J0IGludGVyZmFjZSBJUHJlcmVuZGVyZXJPcHRpb25zXG57XG5cdHN0YXRpY0Rpcj86IHN0cmluZyxcblx0b3V0cHV0RGlyPzogc3RyaW5nLFxuXHRpbmRleFBhdGg/OiBzdHJpbmcsXG5cblx0LyoqXG5cdCAqIFRoZSBwb3N0UHJvY2VzcyhPYmplY3QgY29udGV4dCk6IE9iamVjdCB8IFByb21pc2UgZnVuY3Rpb24gaW4geW91ciByZW5kZXJlciBjb25maWd1cmF0aW9uIGFsbG93cyB5b3UgdG8gYWRqdXN0IHRoZSBvdXRwdXQgb2YgcHJlcmVuZGVyLXNwYS1wbHVnaW4gYmVmb3JlIHdyaXRpbmcgaXQgdG8gYSBmaWxlLlxuXHQgKiBJdCBpcyBjYWxsZWQgb25jZSBwZXIgcmVuZGVyZWQgcm91dGUgYW5kIGlzIHBhc3NlZCBhIGNvbnRleHQgb2JqZWN0IGluIHRoZSBmb3JtIG9mOlxuXHQgKlxuXHQgKiBAcGFyYW0ge0lQb3N0UHJvY2Vzc0NvbnRleHR9IGNvbnRleHRcblx0ICogQHJldHVybnMge0lSZXNvbHZhYmxlPElQb3N0UHJvY2Vzc0NvbnRleHQ+fVxuXHQgKi9cblx0cG9zdFByb2Nlc3M/KGNvbnRleHQ6IElQb3N0UHJvY2Vzc0NvbnRleHQpOiBJUmVzb2x2YWJsZTxJUG9zdFByb2Nlc3NDb250ZXh0PixcblxuXHRzZXJ2ZXI/OiB7XG5cdFx0LyoqXG5cdFx0ICogVGhlIHBvcnQgZm9yIHRoZSBhcHAgc2VydmVyIHRvIHJ1biBvbi5cblx0XHQgKi9cblx0XHRwb3J0PzogbnVtYmVyLFxuXHRcdC8qKlxuXHRcdCAqIFByb3h5IGNvbmZpZ3VyYXRpb24uIEhhcyB0aGUgc2FtZSBzaWduYXR1cmUgYXMgd2VicGFjay1kZXYtc2VydmVyXG5cdFx0ICovXG5cdFx0cHJveHk/OiBvYmplY3QsXG5cdH0sXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVJlc3VsdFxue1xuXHRvcmlnaW5hbFJvdXRlOiBzdHJpbmcsXG5cdHJvdXRlOiBzdHJpbmcsXG5cdGh0bWw6IHN0cmluZyxcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFBhZ2VDb250ZW50cyhqc2RvbTogSlNET00sIG9wdGlvbnM6IElKU0RPTVJlbmRlcmVyT3B0aW9ucywgb3JpZ2luYWxSb3V0ZTogc3RyaW5nKTogQmx1ZWJpcmQ8SVJlc3VsdD5cbntcblx0b3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG5cblx0Y29uc3QgeyB3aW5kb3cgfSA9IGpzZG9tO1xuXHRjb25zdCB7IGRvY3VtZW50IH0gPSB3aW5kb3c7XG5cblx0cmV0dXJuIG5ldyBCbHVlYmlyZDxJUmVzdWx0PigocmVzb2x2ZSwgcmVqZWN0KSA9PlxuXHR7XG5cdFx0bGV0IGludDogbnVtYmVyO1xuXG5cdFx0YXN5bmMgZnVuY3Rpb24gY2FwdHVyZURvY3VtZW50KClcblx0XHR7XG5cdFx0XHRpZiAob3B0aW9ucy5yZW5kZXJBZnRlckRlbGF5ID4gMClcblx0XHRcdHtcblx0XHRcdFx0YXdhaXQgQmx1ZWJpcmQuZGVsYXkob3B0aW9ucy5yZW5kZXJBZnRlckRlbGF5IHwgMClcblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgcmVzdWx0OiBJUmVzdWx0ID0ge1xuXHRcdFx0XHRvcmlnaW5hbFJvdXRlOiBvcmlnaW5hbFJvdXRlLFxuXHRcdFx0XHRyb3V0ZTogb3JpZ2luYWxSb3V0ZSxcblx0XHRcdFx0aHRtbDoganNkb20uc2VyaWFsaXplKCksXG5cdFx0XHR9O1xuXG5cdFx0XHRpZiAoaW50ICE9IG51bGwpXG5cdFx0XHR7XG5cdFx0XHRcdGNsZWFySW50ZXJ2YWwoaW50KVxuXHRcdFx0fVxuXG5cdFx0XHR3aW5kb3cuY2xvc2UoKTtcblx0XHRcdHJldHVybiByZXN1bHRcblx0XHR9XG5cblx0XHRsZXQgYm9vbDogYm9vbGVhbjtcblxuXHRcdC8vIENBUFRVUkUgV0hFTiBBTiBFVkVOVCBGSVJFUyBPTiBUSEUgRE9DVU1FTlRcblx0XHRpZiAob3B0aW9ucy5yZW5kZXJBZnRlckRvY3VtZW50RXZlbnQpXG5cdFx0e1xuXHRcdFx0Ym9vbCA9IHRydWU7XG5cblx0XHRcdGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIob3B0aW9ucy5yZW5kZXJBZnRlckRvY3VtZW50RXZlbnQsICgpID0+IHJlc29sdmUoY2FwdHVyZURvY3VtZW50KCkpKVxuXG5cdFx0XHQvLyBDQVBUVVJFIE9OQ0UgQSBTUEVDSUZDIEVMRU1FTlQgRVhJU1RTXG5cdFx0fVxuXG5cdFx0aWYgKG9wdGlvbnMucmVuZGVyQWZ0ZXJFbGVtZW50RXhpc3RzKVxuXHRcdHtcblx0XHRcdGJvb2wgPSB0cnVlO1xuXG5cdFx0XHQvLyBAdHMtaWdub3JlXG5cdFx0XHRpbnQgPSBzZXRJbnRlcnZhbCgoKSA9PlxuXHRcdFx0e1xuXHRcdFx0XHRpZiAoZG9jdW1lbnQucXVlcnlTZWxlY3RvcihvcHRpb25zLnJlbmRlckFmdGVyRWxlbWVudEV4aXN0cykpIHJlc29sdmUoY2FwdHVyZURvY3VtZW50KCkpXG5cdFx0XHR9LCAxMDApXG5cblx0XHRcdC8vIENBUFRVUkUgQUZURVIgQSBOVU1CRVIgT0YgTUlMTElTRUNPTkRTXG5cdFx0fVxuXG5cdFx0aWYgKGJvb2wpXG5cdFx0e1xuXHRcdFx0c2V0VGltZW91dCgoKSA9PiByZXNvbHZlKGNhcHR1cmVEb2N1bWVudCgpKSwgKG9wdGlvbnMucmVuZGVyQWZ0ZXJUaW1lTWF4IHwgMCkgfHwgMzAwMDApXG5cdFx0fVxuXHRcdGVsc2UgaWYgKG9wdGlvbnMucmVuZGVyQWZ0ZXJUaW1lKVxuXHRcdHtcblx0XHRcdHNldFRpbWVvdXQoKCkgPT4gcmVzb2x2ZShjYXB0dXJlRG9jdW1lbnQoKSksIG9wdGlvbnMucmVuZGVyQWZ0ZXJUaW1lKVxuXG5cdFx0XHQvLyBERUZBVUxUOiBSVU4gSU1NRURJQVRFTFlcblx0XHR9XG5cdFx0ZWxzZVxuXHRcdHtcblx0XHRcdHJlc29sdmUoY2FwdHVyZURvY3VtZW50KCkpXG5cdFx0fVxuXHR9KVxufVxuXG5leHBvcnQgZGVmYXVsdCBKU0RPTVJlbmRlcmVyXG4iXX0=